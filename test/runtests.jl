using Test
using Makie
using Tables
using PairPlots

struct CustomTable{T<:NamedTuple}
    data::T
end

Tables.istable(::Type{<:CustomTable}) = true
Tables.columnaccess(::Type{<:CustomTable}) = true
Tables.columns(t::CustomTable) = t
Tables.columnnames(t::CustomTable) = keys(t.data)
Tables.getcolumn(t::CustomTable, i::Int) = t.data[i]
Tables.getcolumn(t::CustomTable, nm::Symbol) = t.data[nm]
Tables.schema(t::CustomTable) = Tables.schema(t.data)

@testset "Basic functionality" begin
    
    table = (;
        # These are just from randn(100) but don't actually call into Random etc. here
        a=[-0.34354309486711065, -1.0995966004923408, -1.031706382670448, 0.3183044791424319, 0.67787316130825, 1.1324681536249555, 1.2939921062585586, -0.6582203791206142, 1.4695904633205077, 1.5427816212385765, 1.4823524032258817, 0.42815319406559155, -0.4578923008551234, 0.9541115645590403, -1.1768032568149391, 0.09746177747481431, 0.5676618046059924, -0.07301172550842665, 0.2133270257363731, 0.6249497564601051, 0.030033374314663457, 0.9989897307774964, -0.14633638359521245, -0.13984783088967517, -0.07318127088482887, -0.8827464255133538, -0.1551292742796804, -0.5626619648286509, 1.195609759941277, 0.18044593019778774, 0.9906068677115775, 1.067415336363193, -0.09019199880824731, -0.0733557563698599, 1.2365757473020829, 0.6421378506716701, 0.911971133386629, -0.6604354172921325, 1.248280591046975, 2.086058112053022, -1.1209441193889569, -1.8264659931287404, -0.02394457072094552, -0.31598589415658596, 0.14129402137020985, -1.47055974020114, -0.5647486968155041, 0.6213177557341366, 1.47339588963977, 0.5718280587675062, 1.0992536620777364, -0.31467898547034223, -0.33036645614726445, 1.2610107709091767, 0.041089383886570026, -0.8468181989917779, -0.22891621657661404, -0.9619057469455553, -0.31564076522391055, 1.5426666354392973, 0.37072922620724014, -1.294821169478836, -0.3750959408197882, 0.15235550226977407, -1.1352802216110054, -1.4474576663572862, 1.9765748857275764, -1.691136450322534, 0.22417169521718713, -1.014501941287588, 0.9819618489485618, -1.0309264365918522, -0.46725203203010973, -1.9280180251605148, -0.5775542280478414, 3.305450570359804, 0.17791649755099412, -1.3493878073525758, 1.7952206907296888, 0.10818984149605794, -0.8436885213045058, -0.009094522169231267, -1.9067584282323635, -0.4555136343244378, 0.7041913638409038, -0.08615324254645132, 0.07379284355120926, 0.5436464877324115, 0.06375117639292655, -0.42987929424629967, -0.43876721563140775, -1.2559740614842871, -1.0434458219115856, -0.5415017141491355, 0.5924642659992275, 1.54568956318039, 0.8633157674590743, 1.1005805635355026, -1.910737345963861, -0.4742674166832837],
        b=[-0.8350547364341157, -0.038903436082298126, -0.7428209115538095, -1.4702332997988619, 0.2929901876823982, 1.480656821045197, -0.7496016270089672, -1.1816175524449404, -0.8929201507386697, -0.4513027458407115, -0.03467987003478814, -0.01703216323285711, 2.269208613937625, -1.122760313412779, -1.690293811059567, 0.35637058611995015, -0.5492956660472131, 0.46065703485294224, 0.4437979543972946, 0.28240840472432244, 0.690877660142549, -2.5626640462814136, 0.05775480227672292, 0.3471312190888867, 1.724863523389576, -0.30223523085282833, -0.9081864727632714, -0.9755930057667722, -0.8633376120374543, -0.6320827659443491, -0.8996197573701549, 1.3098637982582648, 0.7259306350309777, -0.6677231848170275, -0.24152809622940857, 2.1413209082677906, -1.6229571597346615, 1.6318320479372053, 0.5061999438250513, 1.8722835557539328, -0.28755361383607164, -0.39835043144482646, -1.9191542821529093, 0.1861362910513889, -1.7370796754676385, -0.5847017666989085, -0.6139627808148969, -0.5828743912421838, 0.23866575269053403, 1.1395769333095256, 0.03673066354212003, -1.0246047274123449, 0.81119369428263, -0.2413679376829325, -0.16850699998847837, 0.7193564163546119, -1.0250120470351711, -0.020112597427054398, 1.4023645771518407, -1.2964559002213754, 0.004640153954934036, -1.5456922587361066, -1.1892087658060522, -0.5803343106096389, 1.3773763927487954, -1.5428894968829066, -0.6571326425215163, -0.16942661520407568, 0.3902986077040804, -0.5102558720576744, -1.7157849780094623, 1.6557540726543791, 1.5039386944282804, 0.041349457163033926, 1.726208631975933, 1.5872756183910883, 0.3571235862890753, 0.03145711944329936, -1.0810465561583815, 0.2542573690863064, -0.8061299707651735, 0.6202116497962467, -0.5558158303191691, -0.9388942510860714, 0.850513949232004, -0.4858445604340498, 0.7199256833112352, -0.48438425564853616, 0.0201633201948252, 1.01586069947111, -1.2132268468503575, -0.2566512612879169, -0.08918635759129184, -0.36100301648947447, 0.026391614522651263, 0.7647120517033543, 1.2084488286459771, -0.19298755667218181, 0.1995911553994999, 0.025362662538195947]
    )
    
    @test pairplot(table) isa Figure
    @test pairplot((;table.a)) isa Figure
    @test pairplot(
        table => (PairPlots.Hist(), )
    ) isa Figure
    @test pairplot(
        table => (PairPlots.Hist(), PairPlots.MarginHist())
    ) isa Figure
    @test pairplot(hcat(table.a, table.b)) isa Figure
    @test pairplot(
        table => (PairPlots.Hist(), PairPlots.TrendLine())
    ) isa Figure
    @test pairplot(
        table => (PairPlots.Hist(), PairPlots.Correlation())
    ) isa Figure
    @test pairplot(
        table => (PairPlots.Hist(),),
        PairPlots.Truth((; a = 0.0, b = 0.0))
    ) isa Figure

    ctable = CustomTable(table)
    @test pairplot(ctable) isa Figure
    @test pairplot(
        ctable => (PairPlots.Hist(),)
    ) isa Figure
    @test pairplot(
        ctable => (PairPlots.Hist(), PairPlots.MarginHist())
    ) isa Figure
end
